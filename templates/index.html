{% extends "base.html" %}

{% block title %}Home - Azure Permission Analyzer v1.1{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4">
                <i class="fas fa-shield-alt text-primary me-3"></i>
                Azure Permission Analyzer v1.1
            </h1>
            <p class="lead text-muted">
                Analyze Azure user permissions and role assignments with visual diagrams
            </p>
            <p class="text-muted">
                <small>In-house Custom Built Tool by Razvan Duda</small>
            </p>
        </div>

        <!-- Analysis Form -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>
                    Start Permission Analysis
                </h3>
            </div>
            <div class="card-body">
                <form id="analysisForm" action="" method="post" novalidate>
                    <!-- Subscription ID -->
                    <div class="mb-3">
                        <label for="subscription_id" class="form-label">
                            <i class="fas fa-id-badge me-1"></i>Azure Subscription ID *
                        </label>
                        <input type="text" class="form-control" id="subscription_id" name="subscription_id"
                               autocomplete="off" required
                               placeholder="e.g., 12345678-1234-1234-1234-123456789012">
                        <div class="form-text">The Azure subscription ID to analyze permissions for</div>
                    </div>

                    <!-- User Input Method -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-users me-1"></i>User Selection Method
                        </label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="userMethod" id="singleUser" value="single" checked>
                            <label class="btn btn-outline-primary" for="singleUser">
                                <i class="fas fa-user me-1"></i>Single User
                            </label>

                            <input type="radio" class="btn-check" name="userMethod" id="securityGroup" value="group">
                            <label class="btn btn-outline-primary" for="securityGroup">
                                <i class="fas fa-users-cog me-1"></i>Security Group
                            </label>

                            <input type="radio" class="btn-check" name="userMethod" id="bulkUsers" value="bulk">
                            <label class="btn btn-outline-primary" for="bulkUsers">
                                <i class="fas fa-file-upload me-1"></i>Bulk Upload
                            </label>
                        </div>
                    </div>

                    <!-- Single User Input -->
                    <div class="mb-3" id="singleUserInput">
                        <label for="user_id" class="form-label">
                            <i class="fas fa-user me-1"></i>User Object ID
                        </label>
                        <input type="text" class="form-control" id="user_id" name="user_id"
                               autocomplete="off"
                               placeholder="e.g., 87654321-4321-4321-4321-210987654321">
                        <div class="form-text">The Azure AD object ID of the user to analyze</div>
                    </div>

                    <!-- Security Group Input -->
                    <div class="mb-3 d-none" id="securityGroupInput">
                        <label for="security_group_id" class="form-label">
                            <i class="fas fa-users-cog me-1"></i>Security Group Object ID
                        </label>
                        <input type="text" class="form-control" id="security_group_id" name="security_group_id"
                               autocomplete="off"
                               placeholder="e.g., 12345678-abcd-1234-5678-123456789abc">
                        <div class="form-text">
                            The Azure AD object ID of the security group. All members will be analyzed.
                            <br><small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>You can find the group ID in Azure Portal → Azure Active Directory → Groups
                            </small>
                        </div>
                    </div>

                    <!-- Bulk User Input -->
                    <div class="mb-3 d-none" id="bulkUserInput">
                        <label for="user_list_file" class="form-label">
                            <i class="fas fa-file-upload me-1"></i>User List File
                        </label>
                        <input type="file" class="form-control" id="user_list_file" name="user_list_file" accept=".txt">
                        <div class="form-text">Upload a text file with one user ID per line</div>
                    </div>

                    <!-- Authentication Section -->
                    <div class="card border-secondary mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-key me-2"></i>Authentication
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Authentication Method - Only Encrypted Credentials -->
                            <div class="mb-3">
                                <div class="alert alert-info">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    <strong>Secure Authentication:</strong> This application uses only encrypted service principal credentials for enhanced security.
                                </div>
                                <input type="hidden" name="authMethod" value="stored">
                            </div>

                            <!-- Encrypted Credentials -->
                            <div class="mb-3" id="storedCredentialsSection">
                                <div class="alert alert-info" id="credentialsStatus">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Checking encrypted credentials...
                                </div>
                                <!-- Hidden username field for password manager accessibility -->
                                <input type="text" name="username" autocomplete="username" style="display:none;" aria-hidden="true" tabindex="-1">

                                <label for="master_password" class="form-label">
                                    <i class="fas fa-unlock me-1"></i>Master Password *
                                </label>
                                <input type="password" class="form-control" id="master_password" name="master_password"
                                       autocomplete="current-password" required
                                       placeholder="Enter your master password">
                                <div class="form-text">Password to decrypt your stored Azure service principal credentials</div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn">
                            <i class="fas fa-play me-2"></i>Start Analysis
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Analysis Status -->
        <div class="card shadow mt-4 d-none" id="statusCard">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Analysis Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         id="progressBar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="statusText">Starting analysis...</div>
                <div class="mt-3">
                    <strong>Analysis ID:</strong> <span id="analysisId" class="text-monospace"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>Analysis Complete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultContent">
                    <!-- Results will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="/results" class="btn btn-primary">View All Results</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Fix aria-hidden accessibility warning by managing focus properly
document.addEventListener('DOMContentLoaded', function() {
    // Get all modals
    const modals = document.querySelectorAll('.modal');

    modals.forEach(function(modal) {
        // Before modal hides, blur any focused element inside it
        modal.addEventListener('hide.bs.modal', function() {
            const focusedElement = modal.querySelector(':focus');
            if (focusedElement) {
                focusedElement.blur();
            }
        });

        // After modal is hidden, ensure aria-hidden is properly set
        modal.addEventListener('hidden.bs.modal', function() {
            modal.setAttribute('aria-hidden', 'true');
        });

        // When modal is shown, remove aria-hidden
        modal.addEventListener('shown.bs.modal', function() {
            modal.removeAttribute('aria-hidden');
        });
    });
});
</script>
<script>
// Initialize Mermaid
mermaid.initialize({ startOnLoad: true, theme: 'default' });

// Form handling
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('analysisForm');
    const userMethodRadios = document.querySelectorAll('input[name="userMethod"]');
    const singleUserInput = document.getElementById('singleUserInput');
    const bulkUserInput = document.getElementById('bulkUserInput');
    const statusCard = document.getElementById('statusCard');

    // Check credential status on load
    checkCredentialStatus();

    // Toggle user input method
    userMethodRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const singleUserInput = document.getElementById('singleUserInput');
            const securityGroupInput = document.getElementById('securityGroupInput');
            const bulkUserInput = document.getElementById('bulkUserInput');
            
            // Hide all sections first
            singleUserInput.classList.add('d-none');
            securityGroupInput.classList.add('d-none');
            bulkUserInput.classList.add('d-none');
            
            // Clear all inputs
            document.getElementById('user_id').value = '';
            document.getElementById('security_group_id').value = '';
            document.getElementById('user_list_file').value = '';
            
            // Show selected section
            if (this.value === 'single') {
                singleUserInput.classList.remove('d-none');
            } else if (this.value === 'group') {
                securityGroupInput.classList.remove('d-none');
            } else if (this.value === 'bulk') {
                bulkUserInput.classList.remove('d-none');
            }
        });
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Validate input based on selected method
        const selectedMethod = document.querySelector('input[name="userMethod"]:checked').value;
        let validationError = '';

        if (selectedMethod === 'single') {
            const userId = document.getElementById('user_id').value.trim();
            if (!userId) {
                validationError = 'Please enter a User Object ID';
            }
        } else if (selectedMethod === 'group') {
            const groupId = document.getElementById('security_group_id').value.trim();
            if (!groupId) {
                validationError = 'Please enter a Security Group Object ID';
            }
        } else if (selectedMethod === 'bulk') {
            const fileInput = document.getElementById('user_list_file');
            if (!fileInput.files || fileInput.files.length === 0) {
                validationError = 'Please select a user list file';
            }
        }

        if (validationError) {
            alert(validationError);
            return;
        }

        const formData = new FormData(form);
        const analyzeBtn = document.getElementById('analyzeBtn');

        // Disable form and show status
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';
        statusCard.classList.remove('d-none');

        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                document.getElementById('analysisId').textContent = result.analysis_id;
                monitorAnalysis(result.analysis_id);
            } else {
                throw new Error(result.detail || 'Analysis failed');
            }

        } catch (error) {
            alert('Error starting analysis: ' + error.message);
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Analysis';
            statusCard.classList.add('d-none');
        }
    });
});

async function monitorAnalysis(analysisId) {
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');

    const checkStatus = async () => {
        try {
            const response = await fetch(`/status/${analysisId}`);
            const status = await response.json();

            const progress = (status.completed_users / status.total_users) * 100;
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';

            if (status.status === 'running') {
                statusText.innerHTML = `
                    <strong>Status:</strong> Analyzing user ${status.current_user}<br>
                    <strong>Progress:</strong> ${status.completed_users} of ${status.total_users} users completed
                `;
                setTimeout(checkStatus, 2000);
            } else if (status.status === 'completed') {
                statusText.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Analysis completed successfully! ${status.completed_users} users analyzed.
                    </div>
                `;
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');

                // Show results
                setTimeout(() => {
                    window.location.href = '/results';
                }, 2000);

            } else if (status.status === 'error') {
                statusText.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Analysis failed: ${status.error}
                    </div>
                `;
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
            }

            // Re-enable form
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Analysis';

        } catch (error) {
            console.error('Error checking status:', error);
            statusText.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error checking analysis status. Please refresh the page.
                </div>
            `;
        }
    };

    checkStatus();
}

async function checkCredentialStatus() {
    const statusDiv = document.getElementById('credentialsStatus');

    try {
        const response = await fetch('/api/credentials/status');
        const data = await response.json();

        if (data.exists) {
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = `
                <i class="fas fa-shield-check me-2"></i>
                <strong>Encrypted service principal credentials configured</strong> -
                Created: ${new Date(data.created_at).toLocaleString()}
            `;
        } else {
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>No encrypted service principal credentials found</strong> -
                <a href="/config" class="alert-link">Configure credentials</a> to proceed with analysis
            `;
            
            // Disable the form submit button
            document.getElementById('analyzeBtn').disabled = true;
        }
    } catch (error) {
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Error checking credentials</strong> - Please check configuration
        `;
        
        // Disable the form submit button
        document.getElementById('analyzeBtn').disabled = true;
    }
}

</script>
{% endblock %}