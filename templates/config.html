{% extends "base.html" %}

{% block title %}Configuration - Azure Permission Analyzer{% endblock %}

{% block extra_head %}
<style>
.config-card {
    max-width: 600px;
    margin: 0 auto;
}

.security-info {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-left: 4px solid #28a745;
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
}

.credential-form {
    background: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.password-strength {
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.password-weak { color: #dc3545; }
.password-medium { color: #ffc107; }
.password-strong { color: #28a745; }

.encryption-badge {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.credential-status {
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.status-exists {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    color: #155724;
}

.status-missing {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
    color: #721c24;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="display-5">
                    <i class="fas fa-shield-alt text-success me-3"></i>
                    Secure Configuration
                </h1>
                <p class="lead text-muted">
                    Configure your Azure credentials with military-grade encryption
                </p>
            </div>

            <!-- Security Information -->
            <div class="security-info">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-lock text-success me-2"></i>
                    <strong>Security Features</strong>
                    <span class="encryption-badge ms-auto">
                        <i class="fas fa-certificate me-1"></i>
                        AES-256-GCM
                    </span>
                </div>
                <ul class="list-unstyled mb-0 small">
                    <li><i class="fas fa-check text-success me-1"></i> AES-256-GCM encryption with authenticated encryption</li>
                    <li><i class="fas fa-check text-success me-1"></i> PBKDF2 key derivation with 100,000 iterations</li>
                    <li><i class="fas fa-check text-success me-1"></i> Secure random salt and nonce generation</li>
                    <li><i class="fas fa-check text-success me-1"></i> Credentials expire automatically after 24 hours</li>
                </ul>
            </div>

            <!-- Credential Status -->
            <div id="credentialStatus" class="credential-status">
                <!-- Status will be loaded dynamically -->
            </div>

            <!-- Credential Management Section -->
            <div id="credentialManagement" class="card mb-4" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Credential Management
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Current Credentials Info -->
                    <div id="credentialDetails" class="mb-3">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="testCurrentBtn">
                            <i class="fas fa-flask me-1"></i>Test Connection
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" id="viewDetailsBtn">
                            <i class="fas fa-info-circle me-1"></i>View Details
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" id="updateBtn" data-bs-toggle="collapse" data-bs-target="#updateForm">
                            <i class="fas fa-edit me-1"></i>Update Credentials
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="deleteCurrentBtn">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>

                    <!-- Credential Details Modal Trigger Content -->
                    <div class="collapse mt-3" id="credentialDetailsCollapse">
                        <div class="card card-body bg-light">
                            <div id="detailsContent">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Form -->
            <div class="card config-card credential-form">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>
                        <span id="formTitle">Azure Credentials</span>
                    </h4>
                    <div class="collapse mt-2" id="updateForm">
                        <small class="text-white-50">
                            <i class="fas fa-info-circle me-1"></i>
                            Updating credentials will replace your current configuration
                        </small>
                    </div>
                </div>
                <div class="card-body">
                    <form id="credentialForm" action="/api/credentials/save" method="post" novalidate>
                        <fieldset>
                            <legend class="visually-hidden">Encryption Settings</legend>

                            <!-- Master Password -->
                            <div class="mb-4">
                                <label for="master_password" class="form-label">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Master Password *
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="master_password"
                                           name="master_password" autocomplete="off" required
                                           placeholder="Enter a strong master password">
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    This password encrypts your Azure credentials. Choose a strong, unique password.
                                </div>
                                <div id="passwordStrength" class="password-strength"></div>
                            </div>

                            <!-- Organization Name -->
                            <div class="mb-4">
                                <label for="organization_name" class="form-label">
                                    <i class="fas fa-sitemap me-1"></i>
                                    Organization Name *
                                </label>
                                <input type="text" class="form-control" id="organization_name"
                                       name="organization_name" autocomplete="organization" required
                                       placeholder="e.g., Contoso Corporation">
                                <div class="form-text">
                                    Your organization name (used for analysis identification)
                                </div>
                            </div>
                        </fieldset>

                        <hr class="my-4">

                        <fieldset>
                            <legend class="visually-hidden">Azure Service Principal Credentials</legend>

                            <!-- Azure Tenant ID -->
                            <div class="mb-3">
                                <label for="tenant_id" class="form-label">
                                    <i class="fas fa-building me-1"></i>
                                    Azure Tenant ID *
                                </label>
                                <input type="text" class="form-control" id="tenant_id" name="tenant_id"
                                       autocomplete="off" required
                                       placeholder="e.g., 12345678-1234-1234-1234-123456789012">
                                <div class="form-text">
                                    Your Azure AD Tenant ID (GUID format)
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- Azure Client ID -->
                            <div class="mb-3">
                                <label for="client_id" class="form-label">
                                    <i class="fas fa-id-card me-1"></i>
                                    Service Principal Client ID *
                                </label>
                                <input type="text" class="form-control" id="client_id" name="client_id"
                                       autocomplete="off" required
                                       placeholder="e.g., 87654321-4321-4321-4321-210987654321">
                                <div class="form-text">
                                    Your Service Principal Application (Client) ID
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- Azure Client Secret -->
                            <div class="mb-4">
                                <label for="client_secret" class="form-label">
                                    <i class="fas fa-lock me-1"></i>
                                    Service Principal Client Secret *
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control password-masked" id="client_secret"
                                           name="client_secret" autocomplete="off" aria-autocomplete="none" required
                                           placeholder="Enter your service principal secret">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleSecret">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    Your Service Principal Client Secret (will be encrypted)
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </fieldset>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" id="saveBtn">
                                <i class="fas fa-save me-2"></i>Encrypt & Save
                            </button>
                        </div>
                    </form>

                    <!-- Secondary Action Buttons (outside form) -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <button type="button" class="btn btn-outline-danger me-md-2" id="deleteBtn" style="display: none;">
                            <i class="fas fa-trash me-2"></i>Delete Credentials
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="testBtn" style="display: none;">
                            <i class="fas fa-flask me-2"></i>Test Connection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-question-circle me-2"></i>
                        How to Get Azure Credentials
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user-cog me-1"></i>Create Service Principal</h6>
                            <ol class="small">
                                <li>Go to Azure Portal → Azure Active Directory</li>
                                <li>Select "App registrations" → "New registration"</li>
                                <li>Name your app and register it</li>
                                <li>Copy the "Application (client) ID" and "Directory (tenant) ID"</li>
                                <li>Go to "Certificates & secrets" → Create new client secret</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-shield-alt me-1"></i>Required Permissions</h6>
                            <ul class="small">
                                <li><strong>Microsoft Graph:</strong> User.Read.All, Group.Read.All</li>
                                <li><strong>Azure Service Management:</strong> user_impersonation</li>
                                <li><strong>Azure Subscription:</strong> Reader or custom role with:</li>
                                <ul>
                                    <li>Microsoft.Authorization/roleAssignments/read</li>
                                    <li>Microsoft.Authorization/roleDefinitions/read</li>
                                </ul>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Credentials Saved
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">
                    <i class="fas fa-lock text-success me-2"></i>
                    Your Azure credentials have been securely encrypted and saved using AES-256-GCM encryption.
                    You can now start analyzing permissions.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="/" class="btn btn-primary">Start Analysis</a>
            </div>
        </div>
    </div>
</div>

<!-- Test Results Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-flask me-2"></i>Connection Test Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testResults">
                <!-- Test results will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-warning me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                <p>Are you sure you want to permanently delete your stored Azure credentials?</p>
                <ul class="small text-muted">
                    <li>All encrypted credential data will be securely wiped</li>
                    <li>You will need to reconfigure credentials to use the application</li>
                    <li>Any running analyses will be unaffected</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>Delete Permanently
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Credential Details Modal -->
<div class="modal fade" id="credentialDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Credential Information
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="credentialDetailsModalBody">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Fix aria-hidden accessibility warning by managing focus properly
document.addEventListener('DOMContentLoaded', function() {
    // Get all modals
    const modals = document.querySelectorAll('.modal');

    modals.forEach(function(modal) {
        // Before modal hides, blur any focused element inside it
        modal.addEventListener('hide.bs.modal', function() {
            const focusedElement = modal.querySelector(':focus');
            if (focusedElement) {
                focusedElement.blur();
            }
        });

        // After modal is hidden, ensure aria-hidden is properly set
        modal.addEventListener('hidden.bs.modal', function() {
            modal.setAttribute('aria-hidden', 'true');
        });

        // When modal is shown, remove aria-hidden
        modal.addEventListener('shown.bs.modal', function() {
            modal.removeAttribute('aria-hidden');
        });
    });

    // Original config.html functionality
    (function() {
    const form = document.getElementById('credentialForm');
    const masterPasswordInput = document.getElementById('master_password');
    const tenantIdInput = document.getElementById('tenant_id');
    const clientIdInput = document.getElementById('client_id');
    const clientSecretInput = document.getElementById('client_secret');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const testBtn = document.getElementById('testBtn');
    const testCurrentBtn = document.getElementById('testCurrentBtn');
    const viewDetailsBtn = document.getElementById('viewDetailsBtn');
    const updateBtn = document.getElementById('updateBtn');
    const deleteCurrentBtn = document.getElementById('deleteCurrentBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    // Check credential status on page load
    checkCredentialStatus();

    // Password strength checker
    masterPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
    });

    // Password visibility toggles
    document.getElementById('togglePassword').addEventListener('click', function() {
        togglePasswordVisibility('master_password', this);
    });

    document.getElementById('toggleSecret').addEventListener('click', function() {
        togglePasswordVisibility('client_secret', this);
    });

    // Form validation
    [tenantIdInput, clientIdInput].forEach(input => {
        input.addEventListener('blur', function() {
            validateGuidFormat(this);
        });
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        await saveCredentials();
    });

    // Delete credentials
    deleteBtn.addEventListener('click', async function() {
        if (confirm('Are you sure you want to delete your stored credentials? This action cannot be undone.')) {
            await deleteCredentials();
        }
    });

    // Test connection (existing credentials)
    testBtn.addEventListener('click', async function() {
        await testConnection();
    });

    // Test current credentials
    testCurrentBtn.addEventListener('click', async function() {
        await testCurrentConnection();
    });

    // View credential details
    viewDetailsBtn.addEventListener('click', function() {
        showCredentialDetails();
    });

    // Delete current credentials (show confirmation)
    deleteCurrentBtn.addEventListener('click', function() {
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    });

    // Confirm deletion
    confirmDeleteBtn.addEventListener('click', async function() {
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        deleteModal.hide();
        await deleteCredentials();
    });

let currentCredentialData = null;

async function checkCredentialStatus() {
    const statusDiv = document.getElementById('credentialStatus');
    const managementSection = document.getElementById('credentialManagement');

    try {
        const response = await fetch('/api/credentials/status');
        const data = await response.json();
        currentCredentialData = data;

        if (data.exists) {
            statusDiv.className = 'credential-status status-exists';
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <div>
                        <strong>Credentials Configured & Ready</strong>
                        <div class="small">
                            Your Azure credentials are securely stored and ready for use
                        </div>
                    </div>
                </div>
            `;
            
            // Show management section
            managementSection.style.display = 'block';
            populateCredentialDetails(data);
            
            // Update form buttons
            document.getElementById('deleteBtn').style.display = 'inline-block';
            document.getElementById('testBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-sync me-2"></i>Update Credentials';
            document.getElementById('formTitle').textContent = 'Update Azure Credentials';
        } else {
            statusDiv.className = 'credential-status status-missing';
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    <div>
                        <strong>No Credentials Configured</strong>
                        <div class="small">Configure your Azure credentials to start analyzing permissions</div>
                    </div>
                </div>
            `;
            
            // Hide management section
            managementSection.style.display = 'none';
            document.getElementById('formTitle').textContent = 'Azure Credentials';
        }
    } catch (error) {
        statusDiv.className = 'credential-status status-missing';
        statusDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                <div>
                    <strong>Error Checking Status</strong>
                    <div class="small">Please check your configuration</div>
                </div>
            </div>
        `;
        managementSection.style.display = 'none';
    }
}

function populateCredentialDetails(data) {
    const detailsDiv = document.getElementById('credentialDetails');
    const createdDate = new Date(data.created_at).toLocaleString();
    
    detailsDiv.innerHTML = `
        <div class="row g-3">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <i class="fas fa-calendar-plus text-muted me-2"></i>
                    <div>
                        <small class="text-muted">Created</small>
                        <div class="fw-bold small">${createdDate}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <i class="fas fa-shield-alt text-success me-2"></i>
                    <div>
                        <small class="text-muted">Security</small>
                        <div class="fw-bold small">${data.algorithm}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="progress mt-2" style="height: 3px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
        </div>
    `;
}

function checkPasswordStrength(password) {
    const strengthDiv = document.getElementById('passwordStrength');
    const strength = calculatePasswordStrength(password);

    if (password.length === 0) {
        strengthDiv.innerHTML = '';
        return;
    }

    let className, message;
    if (strength < 3) {
        className = 'password-weak';
        message = 'Weak - Use longer password with mixed characters';
    } else if (strength < 5) {
        className = 'password-medium';
        message = 'Medium - Good, but could be stronger';
    } else {
        className = 'password-strong';
        message = 'Strong - Excellent password strength';
    }

    strengthDiv.className = `password-strength ${className}`;
    strengthDiv.innerHTML = `<i class="fas fa-shield-alt me-1"></i>${message}`;
}

function calculatePasswordStrength(password) {
    let strength = 0;

    // Length bonus
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    if (password.length >= 16) strength++;

    // Character variety
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;

    return strength;
}

function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');

    // Handle password-masked text inputs (client_secret)
    if (input.classList.contains('password-masked')) {
        if (input.classList.contains('show-text')) {
            input.classList.remove('show-text');
            icon.className = 'fas fa-eye';
        } else {
            input.classList.add('show-text');
            icon.className = 'fas fa-eye-slash';
        }
    }
    // Handle traditional password inputs (master_password)
    else if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function validateGuidFormat(input) {
    const guidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    const isValid = guidPattern.test(input.value.trim());

    if (input.value.trim() && !isValid) {
        input.classList.add('is-invalid');
        input.nextElementSibling.nextElementSibling.textContent = 'Must be a valid GUID format (e.g., 12345678-1234-1234-1234-123456789012)';
    } else {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
    }

    return isValid;
}

async function saveCredentials() {
    const formData = new FormData(document.getElementById('credentialForm'));
    const saveBtn = document.getElementById('saveBtn');

    // Validate form
    if (!validateForm()) {
        return;
    }

    // Set loading state
    AzurePermissionAnalyzer.setLoadingState(saveBtn, true);

    try {
        const response = await fetch('/api/credentials/store', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            // Show success modal
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();

            // Clear form
            document.getElementById('credentialForm').reset();

            // Update status
            setTimeout(checkCredentialStatus, 1000);

        } else {
            AzurePermissionAnalyzer.showToast(result.detail || 'Failed to save credentials', 'error');
        }

    } catch (error) {
        AzurePermissionAnalyzer.showToast('Error saving credentials: ' + error.message, 'error');
    } finally {
        AzurePermissionAnalyzer.setLoadingState(saveBtn, false);
    }
}

async function deleteCredentials() {
    const deleteBtn = document.getElementById('deleteBtn');
    AzurePermissionAnalyzer.setLoadingState(deleteBtn, true);

    try {
        const response = await fetch('/api/credentials/delete', {
            method: 'DELETE'
        });

        if (response.ok) {
            AzurePermissionAnalyzer.showToast('Credentials deleted successfully', 'success');
            checkCredentialStatus();
        } else {
            AzurePermissionAnalyzer.showToast('Failed to delete credentials', 'error');
        }

    } catch (error) {
        AzurePermissionAnalyzer.showToast('Error deleting credentials: ' + error.message, 'error');
    } finally {
        AzurePermissionAnalyzer.setLoadingState(deleteBtn, false);
    }
}

async function testConnection() {
    const testBtn = document.getElementById('testBtn');
    const masterPassword = document.getElementById('master_password').value;

    if (!masterPassword) {
        AzurePermissionAnalyzer.showToast('Please enter your master password to test the connection', 'warning');
        return;
    }

    AzurePermissionAnalyzer.setLoadingState(testBtn, true);

    try {
        const response = await fetch('/api/credentials/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                master_password: masterPassword
            })
        });

        const result = await response.json();

        // Show test results modal
        const testModal = new bootstrap.Modal(document.getElementById('testModal'));
        const testResults = document.getElementById('testResults');

        if (response.ok) {
            testResults.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Connection Successful!</strong>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Authentication</h6>
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-check text-success me-1"></i> Azure AD authentication successful</li>
                            <li><i class="fas fa-check text-success me-1"></i> Service principal validated</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Permissions</h6>
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-check text-success me-1"></i> Microsoft Graph API access</li>
                            <li><i class="fas fa-check text-success me-1"></i> Azure Management API access</li>
                        </ul>
                    </div>
                </div>
            `;
        } else {
            testResults.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Connection Failed</strong>
                </div>
                <div class="small">
                    <strong>Error:</strong> ${result.detail || 'Unknown error occurred'}
                </div>
            `;
        }

        testModal.show();

    } catch (error) {
        AzurePermissionAnalyzer.showToast('Error testing connection: ' + error.message, 'error');
    } finally {
        AzurePermissionAnalyzer.setLoadingState(testBtn, false);
    }
}

async function testCurrentConnection() {
    const masterPassword = prompt('Enter your master password to test the stored credentials:');
    if (!masterPassword) return;
    
    const testCurrentBtn = document.getElementById('testCurrentBtn');
    AzurePermissionAnalyzer.setLoadingState(testCurrentBtn, true);

    try {
        const response = await fetch('/api/credentials/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                master_password: masterPassword
            })
        });

        const result = await response.json();

        if (response.ok) {
            AzurePermissionAnalyzer.showToast('✅ Connection test successful! All APIs are accessible.', 'success');
        } else {
            AzurePermissionAnalyzer.showToast('❌ Connection test failed: ' + (result.detail || 'Unknown error'), 'error');
        }

    } catch (error) {
        AzurePermissionAnalyzer.showToast('Error testing connection: ' + error.message, 'error');
    } finally {
        AzurePermissionAnalyzer.setLoadingState(testCurrentBtn, false);
    }
}

function showCredentialDetails() {
    if (!currentCredentialData) return;
    
    const modal = new bootstrap.Modal(document.getElementById('credentialDetailsModal'));
    const modalBody = document.getElementById('credentialDetailsModalBody');
    
    const createdDate = new Date(currentCredentialData.created_at);
    const now = new Date();
    const ageInDays = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-calendar-alt text-primary me-2"></i>Timestamps</h6>
                <table class="table table-sm">
                    <tr>
                        <td class="text-muted">Created:</td>
                        <td><strong>${createdDate.toLocaleString()}</strong></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Age:</td>
                        <td>${ageInDays} days ago</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Version:</td>
                        <td>${currentCredentialData.version}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-lock text-success me-2"></i>Security Details</h6>
                <table class="table table-sm">
                    <tr>
                        <td class="text-muted">Algorithm:</td>
                        <td><strong>${currentCredentialData.algorithm}</strong></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Key Derivation:</td>
                        <td>${currentCredentialData.kdf}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Status:</td>
                        <td><span class="badge bg-success">Active</span></td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="mt-4">
            <h6><i class="fas fa-shield-alt text-info me-2"></i>Security Features</h6>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-check text-success me-1"></i> AES-256-GCM encryption</li>
                        <li><i class="fas fa-check text-success me-1"></i> Authenticated encryption</li>
                        <li><i class="fas fa-check text-success me-1"></i> PBKDF2 key derivation</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-check text-success me-1"></i> 100,000 iterations</li>
                        <li><i class="fas fa-check text-success me-1"></i> Secure random salt</li>
                        <li><i class="fas fa-check text-success me-1"></i> 24-hour expiry</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Note:</strong> Sensitive credential data (passwords, secrets) is never displayed for security reasons.
        </div>
    `;
    
    modal.show();
}

function validateForm() {
    const requiredFields = ['master_password', 'tenant_id', 'client_id', 'client_secret'];
    let isValid = true;

    requiredFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });

    // Validate GUID formats
    if (!validateGuidFormat(document.getElementById('tenant_id'))) {
        isValid = false;
    }
    if (!validateGuidFormat(document.getElementById('client_id'))) {
        isValid = false;
    }

    // Check password strength
    const password = document.getElementById('master_password').value;
    if (password && calculatePasswordStrength(password) < 3) {
        AzurePermissionAnalyzer.showToast('Please use a stronger master password', 'warning');
        isValid = false;
    }

    return isValid;
}

})(); // End of IIFE for config.html functionality
}); // End of DOMContentLoaded
</script>
{% endblock %}